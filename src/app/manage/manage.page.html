<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/"></ion-back-button>
    </ion-buttons>
    <ion-title>Manage Polls</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="openCreateModal()">
        <ion-icon name="add" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Stats Section -->
  <div class="stats-grid">
    <ion-card class="stat-card">
      <ion-card-content>
        <div class="stat-content">
          <ion-icon name="bar-chart" color="primary"></ion-icon>
          <div>
            <h2>{{totalPolls}}</h2>
            <p>Total Polls</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <ion-card class="stat-card">
      <ion-card-content>
        <div class="stat-content">
          <ion-icon name="people" color="success"></ion-icon>
          <div>
            <h2>{{totalVotes}}</h2>
            <p>Total Votes</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <ion-card class="stat-card">
      <ion-card-content>
        <div class="stat-content">
          <ion-icon name="checkmark-circle" color="tertiary"></ion-icon>
          <div>
            <h2>{{activePolls}}</h2>
            <p>Active</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Search Bar -->
  <div class="search-section">
    <ion-searchbar 
      [(ngModel)]="searchText" 
      (ionInput)="filterPolls()" 
      placeholder="Search polls...">
    </ion-searchbar>
  </div>

  <!-- Filter Tabs -->
  <ion-segment [(ngModel)]="selectedFilter" (ionChange)="filterPolls()">
    <ion-segment-button value="all">
      <ion-label>All</ion-label>
    </ion-segment-button>
    <ion-segment-button value="active">
      <ion-label>Active</ion-label>
    </ion-segment-button>
    <ion-segment-button value="closed">
      <ion-label>Closed</ion-label>
    </ion-segment-button>
    <ion-segment-button value="university-wide">
      <ion-label>University-wide</ion-label>
    </ion-segment-button>
    <ion-segment-button value="faculty">
      <ion-label>Faculty</ion-label>
    </ion-segment-button>
    <ion-segment-button value="course">
      <ion-label>Course</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- Category Filter (when faculty or course is selected) -->
  <div class="category-filter" *ngIf="selectedFilter === 'faculty' || selectedFilter === 'course'">
    <ion-select 
      [(ngModel)]="selectedCategory" 
      (ionChange)="filterPolls()" 
      [placeholder]="selectedFilter === 'faculty' ? 'Select Faculty' : 'Select Course'"
      fill="outline">
      <ion-select-option *ngFor="let category of getAvailableCategories()" [value]="category">
        {{category}}
      </ion-select-option>
    </ion-select>
  </div>

  <!-- Polls List -->
  <div class="polls-list">
    <ion-card *ngFor="let poll of displayedPolls" class="poll-card">
      <ion-card-header>
        <div class="poll-header">
          <div class="poll-title-section">
            <ion-card-title>{{poll.title}}</ion-card-title>
            <div class="poll-badges">
              <ion-badge [color]="poll.isActive ? 'success' : 'medium'">
                {{poll.isActive ? 'Active' : 'Closed'}}
              </ion-badge>
              <ion-badge [color]="getCategoryColor(poll.category)" class="category-badge">
                {{poll.categoryType}}: {{poll.category}}
              </ion-badge>
              <ion-badge [color]="poll.allowMultiple ? 'warning' : 'secondary'" class="choice-badge">
                {{poll.allowMultiple ? 'Multiple Choice' : 'Single Choice'}}
              </ion-badge>
            </div>
          </div>
        </div>
        <ion-card-subtitle>{{poll.description}}</ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <div class="poll-info">
          <div class="info-item">
            <ion-icon name="people-outline"></ion-icon>
            <span>{{poll.votes}} votes</span>
          </div>
          <div class="info-item">
            <ion-icon name="calendar-outline"></ion-icon>
            <span>{{poll.createdDate}}</span>
          </div>
          <div class="info-item">
            <ion-icon name="eye-outline"></ion-icon>
            <span>{{poll.isAnonymous ? 'Anonymous' : 'Public'}}</span>
          </div>
        </div>

        <!-- Poll Options Preview -->
        <div class="options-preview">
          <h4>Options:</h4>
          <div class="options-list">
            <span *ngFor="let option of poll.options; let last = last" class="option-preview">
              {{option.text}}<span *ngIf="!last">, </span>
            </span>
          </div>
        </div>

        <div class="poll-actions">
          <ion-button fill="outline" size="small" (click)="viewPollResults(poll)">
            <ion-icon name="bar-chart-outline" slot="start"></ion-icon>
            Results ({{poll.votes}})
          </ion-button>
          <ion-button fill="outline" size="small" (click)="editPoll(poll)">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            Edit
          </ion-button>
          <ion-button 
            fill="outline" 
            size="small" 
            color="danger" 
            (click)="deletePoll(poll.id)">
            <ion-icon name="trash-outline" slot="start"></ion-icon>
            Delete
          </ion-button>
          <ion-button 
            fill="outline" 
            size="small" 
            [color]="poll.isActive ? 'warning' : 'success'"
            (click)="togglePollStatus(poll)">
            <ion-icon [name]="poll.isActive ? 'pause-outline' : 'play-outline'" slot="start"></ion-icon>
            {{poll.isActive ? 'Close' : 'Activate'}}
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="displayedPolls.length === 0">
      <ion-icon name="clipboard-outline" size="large"></ion-icon>
      <h3>No polls found</h3>
      <p>Create your first poll to get started!</p>
      <ion-button (click)="openCreateModal()" expand="block">
        Create Poll
      </ion-button>
    </div>
  </div>

  <!-- FAB -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="openCreateModal()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>

<!-- Create Poll Modal -->
<ion-modal [isOpen]="showCreateModal" (didDismiss)="closeCreateModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{editingPoll ? 'Edit Poll' : 'Create New Poll'}}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeCreateModal()">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <div class="modal-content">
        <!-- Category Selection -->
        <div class="category-section">
          <ion-item>
            <ion-label><strong>Poll Category *</strong></ion-label>
          </ion-item>
          
          <ion-radio-group [(ngModel)]="newPoll.categoryType">
            <ion-item>
              <ion-radio slot="start" value="University-wide"></ion-radio>
              <ion-label>University-wide</ion-label>
            </ion-item>
            <ion-item>
              <ion-radio slot="start" value="Faculty"></ion-radio>
              <ion-label>Faculty Level</ion-label>
            </ion-item>
            <ion-item>
              <ion-radio slot="start" value="Course"></ion-radio>
              <ion-label>Course Level</ion-label>
            </ion-item>
          </ion-radio-group>

          <!-- Faculty Selection -->
          <ion-item *ngIf="newPoll.categoryType === 'Faculty'">
            <ion-label position="stacked">Select Faculty *</ion-label>
            <ion-select [(ngModel)]="newPoll.category" placeholder="Choose Faculty">
              <ion-select-option *ngFor="let faculty of faculties" [value]="faculty">
                {{faculty}}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Course Selection -->
          <ion-item *ngIf="newPoll.categoryType === 'Course'">
            <ion-label position="stacked">Select Course *</ion-label>
            <ion-select [(ngModel)]="newPoll.category" placeholder="Choose Course">
              <ion-select-option *ngFor="let course of courses" [value]="course">
                {{course}}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <!-- Poll Details -->
        <ion-item>
          <ion-label position="stacked">Poll Title *</ion-label>
          <ion-input [(ngModel)]="newPoll.title" placeholder="Enter poll title"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Description</ion-label>
          <ion-textarea [(ngModel)]="newPoll.description" placeholder="Enter description (optional)" rows="3"></ion-textarea>
        </ion-item>

        <!-- Poll Options -->
        <div class="options-section">
          <ion-item>
            <ion-label><strong>Poll Options</strong></ion-label>
          </ion-item>

          <ion-item *ngFor="let option of newPoll.options; let i = index">
            <ion-label position="stacked">Option {{i + 1}} *</ion-label>
            <ion-input [(ngModel)]="option.text" placeholder="Enter option"></ion-input>
            <ion-button fill="clear" slot="end" (click)="removeOption(i)" *ngIf="newPoll.options.length > 2">
              <ion-icon name="trash-outline" color="danger"></ion-icon>
            </ion-button>
          </ion-item>

          <ion-button fill="clear" expand="block" (click)="addOption()" *ngIf="newPoll.options.length < 10">
            <ion-icon name="add" slot="start"></ion-icon>
            Add Option
          </ion-button>
        </div>

        <!-- Poll Settings -->
        <div class="settings-section">
          <ion-item>
            <ion-label><strong>Poll Settings</strong></ion-label>
          </ion-item>

          <ion-item>
            <ion-checkbox [(ngModel)]="newPoll.allowMultiple"></ion-checkbox>
            <ion-label class="ion-margin-start">Allow multiple answers</ion-label>
          </ion-item>

          <ion-item>
            <ion-checkbox [(ngModel)]="newPoll.isAnonymous"></ion-checkbox>
            <ion-label class="ion-margin-start">Anonymous voting</ion-label>
          </ion-item>
        </div>

        <div class="modal-actions">
          <ion-button expand="block" (click)="savePoll()" [disabled]="!canCreatePoll()">
            {{editingPoll ? 'Update Poll' : 'Create Poll'}}
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Results Modal -->
<ion-modal [isOpen]="showResultsModal" (didDismiss)="closeResultsModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Poll Results</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeResultsModal()">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content *ngIf="selectedPollForResults">
      <div class="results-content">
        <div class="results-header">
          <h2>{{selectedPollForResults.title}}</h2>
          <p>{{selectedPollForResults.description}}</p>
          <div class="results-meta">
            <ion-badge [color]="getCategoryColor(selectedPollForResults.category)">
              {{selectedPollForResults.categoryType}}: {{selectedPollForResults.category}}
            </ion-badge>
            <ion-badge color="primary">
              Total Votes: {{selectedPollForResults.votes}}
            </ion-badge>
          </div>
        </div>

        <div class="results-options">
          <div *ngFor="let option of selectedPollForResults.options" class="result-option">
            <div class="option-header">
              <span class="option-text">{{option.text}}</span>
              <span class="vote-count">{{option.votes}} votes</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="getVotePercentage(option.votes, selectedPollForResults.votes)"></div>
            </div>
            <div class="percentage">{{getVotePercentage(option.votes, selectedPollForResults.votes)}}%</div>
          </div>
        </div>

        <!-- Voter Details (if not anonymous) - FIXED LINE -->
        <div class="voter-details" *ngIf="!selectedPollForResults.isAnonymous && selectedPollForResults.voters && selectedPollForResults.voters.length > 0">
          <h3>Voters</h3>
          <ion-list>
            <ion-item *ngFor="let voter of selectedPollForResults.voters">
              <ion-avatar slot="start">
                <img [src]="voter.avatar || 'assets/default-avatar.png'" />
              </ion-avatar>
              <ion-label>
                <h3>{{voter.name}}</h3>
                <p>{{voter.studentId}} - {{voter.course}}</p>
                <p><strong>Voted:</strong> {{voter.selectedOptions.join(', ')}}</p>
              </ion-label>
              <ion-note slot="end">{{voter.votedAt}}</ion-note>
            </ion-item>
          </ion-list>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>