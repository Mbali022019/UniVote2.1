<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/"></ion-back-button>
    </ion-buttons>
    <ion-title>Active Polls</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="polls-bg" (click)="closeCategoryDropdown()">
  <div class="polls-container">
    <!-- Search and Filter Section -->
    <div class="search-filter-section">
      <!-- Search Bar -->
      <div class="search-container glass-card">
        <ion-searchbar
          [(ngModel)]="searchQuery"
          (ionInput)="onSearchInput($event)"
          placeholder="Search polls..."
          show-clear-button="focus"
          debounce="300"
          class="custom-searchbar">
          <ion-icon name="search" slot="start"></ion-icon>
        </ion-searchbar>
      </div>

      <!-- Category Dropdown Filter -->
      <div class="category-filter glass-card">
        <div class="category-header">
          <ion-icon name="filter"></ion-icon>
          <span>Academic Level</span>
        </div>
        
        <!-- Dropdown Button -->
        <div class="dropdown-container">
          <button 
            class="dropdown-button"
            (click)="toggleCategoryDropdown(); $event.stopPropagation()">
            <div class="dropdown-selected">
              <ion-icon [name]="getCategoryIcon(selectedCategory)"></ion-icon>
              <span>{{getSelectedCategoryName()}}</span>
            </div>
            <ion-icon 
              name="chevron-down" 
              class="dropdown-arrow"
              [class.rotated]="isCategoryDropdownOpen">
            </ion-icon>
          </button>

          <!-- Dropdown Menu -->
          <div class="dropdown-menu" [class.open]="isCategoryDropdownOpen" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);">
            
            <!-- Course Level -->
            <div class="dropdown-group">
              <div class="dropdown-group-header" style="background: rgba(0, 123, 255, 0.1); color: #007bff; padding: 12px 16px; font-weight: 600;">
                <ion-icon name="book"></ion-icon>
                <span>Course</span>
              </div>
              <div 
                class="dropdown-item course-item"
                [class.selected]="selectedCategory === 'course'"
                (click)="selectCategory('course'); $event.stopPropagation()"
                style="padding: 12px 24px; color: #333; background: rgba(0, 0, 0, 0.02); cursor: pointer;">
                <ion-icon name="code-slash"></ion-icon>
                <span>IT Development (IT301)</span>
              </div>
            </div>

            <!-- Faculty Level -->
            <div class="dropdown-group">
              <div class="dropdown-group-header" style="background: rgba(40, 167, 69, 0.1); color: #28a745; padding: 12px 16px; font-weight: 600;">
                <ion-icon name="people"></ion-icon>
                <span>Faculty</span>
              </div>
              <div 
                class="dropdown-item faculty-item"
                [class.selected]="selectedCategory === 'faculty'"
                (click)="selectCategory('faculty'); $event.stopPropagation()"
                style="padding: 12px 24px; color: #333; background: rgba(0, 0, 0, 0.02); cursor: pointer;">
                <ion-icon name="medical"></ion-icon>
                <span>Applied Health & Sciences</span>
              </div>
            </div>

            <!-- University Level -->
            <div class="dropdown-group">
              <div class="dropdown-group-header" style="background: rgba(220, 53, 69, 0.1); color: #dc3545; padding: 12px 16px; font-weight: 600;">
                <ion-icon name="school"></ion-icon>
                <span>University</span>
              </div>
              <div 
                class="dropdown-item university-item"
                [class.selected]="selectedCategory === 'university'"
                (click)="selectCategory('university'); $event.stopPropagation()"
                style="padding: 12px 24px; color: #333; background: rgba(0, 0, 0, 0.02); cursor: pointer;">
                <ion-icon name="school"></ion-icon>
                <span>University-wide Polls</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Results Count -->
    <div class="results-info" *ngIf="filteredPolls.length > 0 && selectedCategory">
      <span>{{filteredPolls.length}} poll{{filteredPolls.length !== 1 ? 's' : ''}} found</span>
    </div>

    <!-- Poll Cards -->
    <div class="poll-list" *ngIf="selectedCategory">
      <div class="glass-card poll-card" *ngFor="let poll of filteredPolls; trackBy: trackByPollId">
        <!-- Poll Preview (Collapsed State) -->
        <div class="poll-preview" *ngIf="!isExpanded(poll.id)">
          <div class="poll-header">
            <div class="poll-avatar">
              <img *ngIf="poll.creatorAvatar" [src]="poll.creatorAvatar" [alt]="poll.creatorName">
              <ion-icon name="person-circle" *ngIf="!poll.creatorAvatar"></ion-icon>
            </div>
            <div class="poll-meta">
              <h3 class="poll-creator">{{poll.creatorName}}</h3>
              <p class="poll-time">{{poll.createdDate}}</p>
              <div class="poll-academic-info">
                <ion-icon [name]="getPollScopeIcon(poll)"></ion-icon>
                <span>{{getPollScopeInfo(poll)}}</span>
              </div>
            </div>
            <div class="poll-status">
              <div class="status-badge" [class]="getStatusClass(poll)">
                {{getStatusText(poll)}}
              </div>
            </div>
          </div>

          <div class="poll-question-preview">
            <h2>{{poll.title}}</h2>
            <p class="poll-description" *ngIf="poll.description">
              {{poll.description.length > 100 ? (poll.description | slice:0:100) + '...' : poll.description}}
            </p>
          </div>

          <div class="poll-stats-preview">
            <div class="stat-item">
              <ion-icon name="people"></ion-icon>
              <span>{{poll.totalVotes}} votes</span>
            </div>
            <div class="stat-item">
              <ion-icon [name]="poll.allowMultiple ? 'checkbox' : 'radio-button-on'"></ion-icon>
              <span>{{poll.allowMultiple ? 'Multiple' : 'Single'}} choice</span>
            </div>
            <div class="stat-item">
              <ion-icon name="list"></ion-icon>
              <span>{{poll.options.length}} options</span>
            </div>
          </div>

          <div class="view-poll-button">
            <ion-button 
              class="view-btn neon-button-outline"
              expand="block"
              (click)="expandPoll(poll.id)">
              <ion-icon name="eye" slot="start"></ion-icon>
              View Poll
            </ion-button>
          </div>
        </div>

        <!-- Full Poll Content (Expanded State) -->
        <div class="poll-full" *ngIf="isExpanded(poll.id)">
          <!-- Collapse Button -->
          <div class="collapse-header">
            <ion-button 
              fill="clear" 
              class="collapse-btn"
              (click)="collapsePoll(poll.id)">
              <ion-icon name="chevron-up" slot="start"></ion-icon>
              Collapse
            </ion-button>
          </div>

          <!-- Poll Header with Creator Info -->
          <div class="poll-header">
            <div class="poll-avatar">
              <img *ngIf="poll.creatorAvatar" [src]="poll.creatorAvatar" [alt]="poll.creatorName">
              <ion-icon name="person-circle" *ngIf="!poll.creatorAvatar"></ion-icon>
            </div>
            <div class="poll-meta">
              <h3 class="poll-creator">{{poll.creatorName}}</h3>
              <p class="poll-time">{{poll.createdDate}}</p>
              <div class="poll-academic-info">
                <ion-icon [name]="getPollScopeIcon(poll)"></ion-icon>
                <span>{{getPollScopeInfo(poll)}}</span>
              </div>
            </div>
          </div>

          <!-- Poll Question -->
          <div class="poll-question">
            <h2>{{poll.title}}</h2>
            <p class="poll-description" *ngIf="poll.description">{{poll.description}}</p>
          </div>

          <!-- Poll Options -->
          <div class="poll-options">
            <div 
              class="poll-option" 
              *ngFor="let option of poll.options; let i = index"
              [class.selected]="isOptionSelected(poll.id, option.id)"
              [class.voted]="hasUserVoted(poll.id)"
              (click)="!hasUserVoted(poll.id) && selectOption(poll.id, option.id, poll.allowMultiple)">
              
              <div class="option-header">
                <!-- Radio Button for Single Choice -->
                <div class="radio-container" *ngIf="!poll.allowMultiple">
                  <input 
                    type="radio" 
                    [id]="'poll_' + poll.id + '_option_' + option.id"
                    [name]="'poll_' + poll.id"
                    [value]="option.id"
                    [checked]="isOptionSelected(poll.id, option.id)"
                    [disabled]="hasUserVoted(poll.id)"
                    (change)="selectOption(poll.id, option.id, poll.allowMultiple)">
                  <label 
                    class="radio-label" 
                    [for]="'poll_' + poll.id + '_option_' + option.id">
                    <span class="radio-button"></span>
                  </label>
                </div>

                <!-- Checkbox for Multiple Choice -->
                <div class="radio-container" *ngIf="poll.allowMultiple">
                  <input 
                    type="checkbox" 
                    [id]="'poll_' + poll.id + '_option_' + option.id"
                    [value]="option.id"
                    [checked]="isOptionSelected(poll.id, option.id)"
                    [disabled]="hasUserVoted(poll.id)"
                    (change)="selectOption(poll.id, option.id, poll.allowMultiple)">
                  <label 
                    class="radio-label" 
                    [for]="'poll_' + poll.id + '_option_' + option.id">
                    <span class="radio-button" [class.checkbox]="poll.allowMultiple"></span>
                  </label>
                </div>

                <div class="option-content">
                  <span class="option-text">{{option.text}}</span>
                  <!-- Removed vote count display - users cannot see results -->
                </div>
              </div>

              <!-- Removed progress bars - users cannot see results -->
              
              <!-- Preview Selection Indicator (shown while selecting) -->
              <div class="vote-progress" *ngIf="!hasUserVoted(poll.id) && isOptionSelected(poll.id, option.id)">
                <div class="progress-bar preview-bar" style="width: 100%"></div>
                <span class="preview-text">Selected</span>
              </div>
            </div>
          </div>

          <!-- Vote Button -->
          <div class="vote-button-container" *ngIf="!hasUserVoted(poll.id)">
            <ion-button 
              class="vote-btn neon-button"
              expand="block"
              [disabled]="!hasSelectedOptions(poll.id)"
              (click)="submitVote(poll)">
              <ion-icon name="checkmark-circle" slot="start"></ion-icon>
              Submit Vote
            </ion-button>
          </div>

          <!-- Thank You Message (After Voting) -->
          <div class="thank-you-container" *ngIf="hasUserVoted(poll.id)">
            <div class="thank-you-message">
              <ion-icon name="checkmark-circle" color="success"></ion-icon>
              <h3>Thank you for voting!</h3>
              <p>Your vote has been submitted successfully.</p>
            </div>
          </div>

          <!-- Poll Stats -->
          <div class="poll-stats">
            <div class="total-votes">
              <ion-icon name="people"></ion-icon>
              <span>{{poll.totalVotes}} total votes</span>
            </div>
            <div class="poll-type">
              <ion-icon [name]="poll.allowMultiple ? 'checkbox' : 'radio-button-on'"></ion-icon>
              <span>{{poll.allowMultiple ? 'Multiple choice' : 'Single choice'}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Category Selection Required -->
    <div class="glass-card empty-state" *ngIf="!selectedCategory">
      <div class="empty-content">
        <ion-icon name="funnel-outline"></ion-icon>
        <h2>Select a Category</h2>
        <p>Please choose a category from the dropdown above to view polls</p>
      </div>
    </div>

    <!-- Empty State -->
    <div class="glass-card empty-state" *ngIf="selectedCategory && filteredPolls.length === 0 && polls.length > 0">
      <div class="empty-content">
        <ion-icon name="search-outline"></ion-icon>
        <h2>No polls found</h2>
        <p>No polls available for the selected category</p>
        <ion-button 
          class="clear-filters-btn neon-button-outline"
          (click)="clearFilters()">
          Clear Filters
        </ion-button>
      </div>
    </div>

    <!-- No Polls State -->
    <div class="glass-card empty-state" *ngIf="selectedCategory && polls.length === 0">
      <div class="empty-content">
        <ion-icon name="clipboard-outline"></ion-icon>
        <h2>No Active Polls</h2>
        <p>Check back later for new polls to participate in!</p>
      </div>
    </div>
  </div>
</ion-content>
