<!-- profile.page.html -->
<ion-header [translucent]="true" class="custom-header">
  <ion-toolbar class="nav-header">
    <ion-buttons slot="start">
      <ion-button class="nav-back" fill="clear" (click)="goBack()">
        <ion-icon name="arrow-back" slot="start"></ion-icon>
        Back to Menu
      </ion-button>
    </ion-buttons>
    
    <ion-title class="nav-title">Student Profile</ion-title>
    
    <ion-buttons slot="end">
      <ion-button class="nav-edit-btn" fill="clear" (click)="toggleEditMode()" [title]="isEditing ? 'Save Changes' : 'Edit Profile'">
        <ion-icon [name]="isEditing ? 'checkmark' : 'create'"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="profile-content">
  <!-- Animated Background Particles -->
  <div class="bg-animation">
    <div class="particle" *ngFor="let p of particles; let i = index" [style.transform]="p.transform"></div>
  </div>

  <div class="profile-container">
    <div class="profile-wrapper">
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-avatar" 
             (click)="showProfilePictureOptions()" 
             (drop)="handleDrop($event)" 
             (dragover)="handleDragOver($event)" 
             (dragleave)="handleDragLeave($event)"
             [class.drag-over]="isDragOver">
          <img #avatarImage 
               class="avatar-image" 
               [src]="avatarUrl" 
               [style.display]="avatarUrl ? 'block' : 'none'" 
               alt="Profile Picture">
          <div class="avatar-placeholder" [style.display]="!avatarUrl ? 'block' : 'none'">
            {{getInitials()}}
          </div>
          <div class="avatar-overlay">
            <ion-icon name="camera" class="upload-icon"></ion-icon>
            <div class="upload-text">Change Photo</div>
          </div>
        </div>
        
        <!-- Hidden file inputs -->
        <input #cameraInput 
               type="file" 
               class="file-input" 
               accept="image/*" 
               capture="camera"
               (change)="handleCameraCapture($event)">
        <input #galleryInput 
               type="file" 
               class="file-input" 
               accept="image/*" 
               (change)="handleGallerySelect($event)">
        
        <div class="student-info">
          <div class="student-id">{{userProfile.studentId}}</div>
          <div class="course-name">{{userProfile.department}}</div>
        </div>
      </div>

      <!-- Personal Information Section -->
      <div class="form-section">
        <h2 class="section-title">Personal Information</h2>
        <form [formGroup]="profileForm" class="form-grid">
          <div class="form-field">
            <div class="input-group">
              <ion-label class="form-label" position="floating">First Name</ion-label>
              <ion-input 
                class="form-input" 
                formControlName="firstName" 
                placeholder="Enter first name"
                [readonly]="!isEditing">
              </ion-input>
            </div>
          </div>
          
          <div class="form-field">
            <div class="input-group">
              <ion-label class="form-label" position="floating">Last Name</ion-label>
              <ion-input 
                class="form-input" 
                formControlName="lastName" 
                placeholder="Enter last name"
                [readonly]="!isEditing">
              </ion-input>
            </div>
          </div>
          
          <div class="form-field">
            <div class="input-group">
              <ion-label class="form-label" position="floating">Email Address</ion-label>
              <ion-input 
                class="form-input" 
                type="email" 
                formControlName="email" 
                placeholder="Enter email address"
                [readonly]="!isEditing">
              </ion-input>
            </div>
          </div>
          
          <div class="form-field">
            <div class="input-group">
              <ion-label class="form-label" position="floating">Phone Number</ion-label>
              <ion-input 
                class="form-input" 
                type="tel" 
                formControlName="phone" 
                placeholder="Enter phone number"
                [readonly]="!isEditing">
              </ion-input>
            </div>
          </div>
          
          <div class="form-field">
            <div class="input-group date-input-group">
              <ion-label class="form-label" position="floating">Date of Birth</ion-label>
              <div class="date-picker-container">
                <ion-input 
                  class="form-input date-display" 
                  [value]="getFormattedDate(profileForm.get('dateOfBirth')?.value)"
                  placeholder="Select date of birth"
                  [readonly]="true"
                  (click)="openDatePicker()">
                </ion-input>
                <ion-button 
                  fill="clear" 
                  class="date-picker-button"
                  (click)="openDatePicker()"
                  [disabled]="!isEditing">
                  <ion-icon name="calendar-outline"></ion-icon>
                </ion-button>
              </div>
              <ion-datetime 
                #dateTimePicker
                class="compact-date-picker" 
                formControlName="dateOfBirth" 
                presentation="date"
                [isOpen]="isDatePickerOpen"
                (ionChange)="onDateChange($event)"
                (ionCancel)="closeDatePicker()"
                [disabled]="!isEditing">
              </ion-datetime>
            </div>
          </div>
          
          <div class="form-field">
            <div class="input-group">
              <ion-label class="form-label" position="floating">Gender</ion-label>
              <ion-select 
                class="form-select" 
                formControlName="gender" 
                placeholder="Select Gender"
                [disabled]="!isEditing">
                <ion-select-option value="">Select Gender</ion-select-option>
                <ion-select-option value="male">Male</ion-select-option>
                <ion-select-option value="female">Female</ion-select-option>
                <ion-select-option value="other">Other</ion-select-option>
                <ion-select-option value="prefer-not-to-say">Prefer not to say</ion-select-option>
              </ion-select>
            </div>
          </div>
          
          <div class="form-field full-width">
            <div class="input-group">
              <ion-label class="form-label" position="floating">Address</ion-label>
              <ion-textarea 
                class="form-textarea" 
                formControlName="address" 
                placeholder="Enter your full address"
                [readonly]="!isEditing">
              </ion-textarea>
            </div>
          </div>
        </form>
      </div>

      <!-- Academic Information Section -->
      <div class="form-section">
        <h2 class="section-title">Academic Information</h2>
        <div class="form-grid">
          <div class="form-field">
            <div class="input-group">
              <ion-label class="form-label" position="floating">Student ID</ion-label>
              <ion-input 
                class="form-input" 
                formControlName="studentId" 
                placeholder="Enter student ID"
                [readonly]="!isEditing">
              </ion-input>
            </div>
          </div>
          
          <div class="form-field">
            <div class="input-group">
              <ion-label class="form-label" position="floating">Department</ion-label>
              <ion-select 
                class="form-select" 
                formControlName="department" 
                placeholder="Select Department"
                [disabled]="!isEditing">
                <ion-select-option value="">Select Department</ion-select-option>
                <ion-select-option value="computer-science">Computer Science</ion-select-option>
                <ion-select-option value="engineering">Engineering</ion-select-option>
                <ion-select-option value="business">Business Administration</ion-select-option>
                <ion-select-option value="psychology">Psychology</ion-select-option>
                <ion-select-option value="medicine">Medicine</ion-select-option>
                <ion-select-option value="law">Law</ion-select-option>
                <ion-select-option value="arts">Arts & Literature</ion-select-option>
                <ion-select-option value="mathematics">Mathematics</ion-select-option>
              </ion-select>
            </div>
          </div>
          
          <div class="form-field">
            <div class="input-group">
              <ion-label class="form-label" position="floating">Year of Study</ion-label>
              <ion-select 
                class="form-select" 
                formControlName="yearOfStudy" 
                placeholder="Select Year"
                [disabled]="!isEditing">
                <ion-select-option value="">Select Year</ion-select-option>
                <ion-select-option value="1">1st Year</ion-select-option>
                <ion-select-option value="2">2nd Year</ion-select-option>
                <ion-select-option value="3">3rd Year</ion-select-option>
                <ion-select-option value="4">4th Year</ion-select-option>
                <ion-select-option value="postgrad">Postgraduate</ion-select-option>
              </ion-select>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <ion-button 
          class="action-btn btn-primary" 
          expand="block" 
          (click)="saveProfile()"
          [disabled]="!isEditing || profileForm.invalid">
          <ion-icon name="save" slot="start"></ion-icon>
          Save Changes
        </ion-button>
        
        <ion-button 
          class="action-btn btn-secondary" 
          expand="block" 
          fill="outline" 
          (click)="resetForm()">
          <ion-icon name="refresh" slot="start"></ion-icon>
          Reset Form
        </ion-button>
      </div>
    </div>
  </div>
</ion-content>